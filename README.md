# Machine-Learning-in-TLS-Malware-Detection
## 目的

1. 对从网络环境中抓取到的流量数据进行处理和筛查

2. 在不对其解密的情况下分析检测出加密网络数据包中的恶意行为数据包及其归属

3. 计算相应的检测准确率和误报率

4. 将统计分析结果以图表方式清晰呈现。

## 环境搭建

系统：Windows 10

Python：使用Python 3.8.x

脚本machine_learning.ipynb、gettls.py、predict_funcs.py和ui.py

字节码对照文件目录protocal

标准库csv、math、traceback

第三方库Scapy 2.4.4、Sk-learn 0.23.2、Joblib 0.16.0、Numpy 1.18.5、Matplotlib 3.2.2、Scipy 2.4.4、Pandas 1.0.4、Seaborn 0.11.0、PyQt5 5.15.0

以及针对scapy ssl/tls layer的第三方拓展包。 

相应实验代码所在目录tree：

root:machine_learning_in_malware_tls_detection
+--data
| +--cipher_ext_port_stunt1.csv
| +--cipher_ext_stunt1.csv
| +--cipher_stunted1.csv
| +--cs_ext_dict
| +--demo.pcap
| +--sample.csv
+--model
| +--logistics_regression_classifier.pkl
| +--new_logistci_regression_model.pkl
| +--new_random_forest_model.pkl
| +--new_svm_model.pkl
| +--random_forest_model.pkl
| +--svm_classifier.pkl
+--gettls.py
+--machine_learning.ipynb
+--predict_funcs.py
+--ui.py

由于scapy天生并不支持SSL/TLS解析，且旧的[scapy-ssl_tls](https://github.com/tintinweb/scapy-ssl_tls)拓展不支持Python3，因此拓展代码使用的是kalidasya更改后的scapy-ssl_tls拓展，项目地址：[https://github.com/kalidasya/scapy-ssl_tls/tree/py3_update](https://github.com/kalidasya/scapy-ssl_tls/tree/py3_update)

1. 安装scapy-ssl

查看Python版本，解压缩scapy-ssl_tls-py3_update.zip,利用pip安装scapy等第三方库及相关依赖包，查看scapy包安装位置，将zip解压的指定内容导入相应位置，最后修改scapy的配置文件，将ssl_tls添加进load_layers列表中，完成导入：

```
[Sewell]: ~/Downloads/XDU
➜  which python
/usr/local/bin/python
[Sewell]: ~/Downloads/XDU
➜  unzip scapy-ssl_tls-py3_update.zip
[Sewell]: ~/Downloads/XDU
➜  cd scapy-ssl_tls-py3_update
[Sewell]: ~/Downloads/XDU/scapy-ssl_tls-py3_update
➜  pip install -r requirements.txt
Requirement already satisfied: pycryptodomex>=3.4 in /usr/local/lib/python3.8/site-packages (from -r requirements.txt (line 1)) (3.9.4)
Requirement already satisfied: scapy==2.4.* in /usr/local/lib/python3.8/site-packages (from -r requirements.txt (line 2)) (2.4.4)
Requirement already satisfied: tinyec>=0.3.1 in /usr/local/lib/python3.8/site-packages (from -r requirements.txt (line 3)) (0.3.1)
[Sewell]: ~/Downloads/XDU/scapy-ssl_tls-py3_update
➜  python -c "import scapy; print(scapy.__file__)"
/usr/local/lib/python3.8/site-packages/scapy/__init__.py
[Sewell]: ~/Downloads/XDU/scapy-ssl_tls-py3_update
➜  cp scapy_ssl_tls/* /usr/local/lib/python3.8/site-packages/scapy/layers/
[Sewell]: ~/Downloads/XDU/scapy-ssl_tls-py3_update
➜  vim /usr/local/lib/python3.8/site-packages/scapy/config.py

注：配置信息修改可查看scapy-ssl_tls-py3_update文件夹下的README.md。

验证配置结果：进入python交互页面，或使用ipython。

```
In [1]: from scapy.all import *
In [2]: TLS
Out[2]: scapy.layers.ssl_tls.SSL
```
无报错，且成功识别出TLS即配置成功。

2. 安装numpy第三方库

打开https://www.lfd.uci.edu/~gohlke/pythonlibs/，下载numpy-1.18.5+mkl-cp27-cp37-win_amd64.whl

找到下载的文件的路径，打开windows的DOS命令行窗口，执行如下命令：

pip install numpy-1.15.4+mkl-cp37-cp37m-win_amd64.whl

显示Successfully installed numpy-1.15.4 即安装成功

3. 安装scipy第三方库

打开https://www.lfd.uci.edu/~gohlke/pythonlibs/，下载scipy-2.4.4+mkl-cp27-cp37-win——amd64.whl

找到下载的文件的路径，打开windows的DOS命令行窗口，执行如下命令：

pip install scipy-2.4.4-cp37-cp37m-win_amd64.whl

显示Successfully installed scipy-2.4.4 即安装成功

4. 安装matplotlib第三方库

打开https://www.lfd.uci.edu/~gohlke/pythonlibs/，下载matplotlib-3.2.2+mkl-cp27-cp37-win——amd64.whl

找到下载的文件的路径，打开windows的DOS命令行窗口，执行如下命令：

pip install matplotlib-3.2.2-cp37-cp37m-win_amd64.whl

显示Successfully installed matplotlib-3.2.2 即安装成功

5. 安装scikit_learn第三方库

打开https://www.lfd.uci.edu/~gohlke/pythonlibs/，下载scikit_learn-0.23.2+mkl-cp27-cp37-win——amd64.whl

找到下载的文件的路径，打开windows的DOS命令行窗口，执行如下命令：

pip install scikit_learn-0.23.2-cp37-cp37m-win_amd64.whl

显示Successfully installed scikit_learn-0.23.2 即安装成功

6. 安装pandas第三方库

打开windows的DOS命令行窗口，执行如下命令：

pip install pandas

显示Successfully installed pandas 1.0.4 即安装成功

7. 安装seaborn第三方库

打开windows的DOS命令行窗口，执行如下命令：

pip install seaborn

显示Successfully installed seaborn 0.11.0 即安装成功

8. 安装PyQt5第三方库

打开windows的DOS命令行窗口，执行如下命令：

pip install PyQt5

显示Successfully installed PyQt5 5.15.0 即安装成功

##特征提取

测试使用的原始pcap数据包来自Stratosphere Lab公开的恶意软件捕获结果集，目前公开有349个恶意样本集，涵盖了大多数恶意软件家族的原始流量数据及相应的二进制恶意软件。

其中选取从2015年7月8日至2018年4月3日共来自Wisdomeyes、Trickbot、HTbot、Geodo、Bunitu、Emotet、Artemis、Dridex八个恶意流量家族数据和同等数量级的普通数据用作训练集。

1. 将原始pcap数据集放到data目录下，赋予predict_funcs脚本执行权限，并执行脚本，返回按session分割的结果。

2. 执行gettls脚本，解析相关报文，从一个Session中得到包含源端口与目的端口、密码套件、Session流数据包平均长度、信息熵在内的19项特征。

3. 输出每个数据流的特征，保存为csv格式，文件名为家族名.csv。

*注：特征字段名及含义见附录1。*

4. 将所有csv文件合并为一个文件，文件名为feature.csv。

# 模型训练

将特征scv文件放到data目录下，赋予machine_learning脚本执行权限，并执行脚本，输出逻辑回归、随机森林、SVM三种分类模型pkl文件到model目录下并以相应分类名命名。

# 程序使用

1. 在线抓包

运行ui脚本，选择需要抓取的报文种类，点击右侧“开始抓包”按钮对网络流量进行捕获。

将会在框图中实时显示所抓取报文的来源、去向、类型以及详细数据，并在下方显示正常流量数、恶意流量数及其类别。

2. 离线抓包

运行ui脚本，在下面选择需要进行分析的离线文件路径。

点击右侧“分析离线包”按钮对相应的pcap文件进行分析，同时在框图中实时显示报文的来源、去向、类型以及详细数据，下方显示分析进度条。

## 附录1 特征结构

特征字段名及相应描述：

| 字段名               | 特征描述                |
| ----------------- | ------------------- |
| Dst_Port		| 目的端口      |
| Src_Port 	| 源端口      |
| pkts_cnt 		 | Session流中数据包数量      |
| sessn_dur	| Session流持续时长        |
| total_bytes	| Session流总字节数        |
| pkts_len_avg 	| Session流中数据包平均包长    |
| total_bytes_tls 	| Session流中TLS数据包总字节数 |
| tlss_len_avg	| Session流中TLS数据包平均长度 |
| tls_cip		| TLS使用的密码套件          |
| cs		| 密码套件值          |
| ext		| 扩展版本           |
| tls_exttype	 | TLS使用的拓展组件类型        |
| mean		| TCP Payload 字段期望           |
| std 		| TCP Payload 字段方差           |
| entropy 		| 信息熵           |

特征输出格式：

```
Dst_Port, Src_Port，pkts_cnt, sessn_dur,total_bytes,pkts_len_avg,total_bytes_tls,tlss_len_avg,tls_cip, tls_comp, tls_extlen, tls_exttype,cs_vector,ext_vector,mean,std,entropy

```

## 附录2 其他

1. scapy帮助文档：[https://www.osgeo.cn/scapy](https://www.osgeo.cn/scapy)   

2. sklearn帮助文档：http://www.scikitlearn.com.cn/
3. joblib帮助文档：https://pypi.org/project/joblib/

4. Numpy 帮助文档：https://www.numpy.org.cn/

5. Matplotlib 帮助文档：https://pandas.pydata.org/pandas-docs/stable/

6. Scipy 帮助文档：https://docs.scipy.org/doc/scipy/reference/tutorial/index.html

7. Pandas 帮助文档：http://seaborn.pydata.org/

8. Seaborn 帮助文档：http://seaborn.pydata.org/

9. PyQt5 帮助文档：https://www.riverbankcomputing.com/software/pyqt/

10. SSL/TLS Cipher Suites 对照表：`openssl ciphers -V | column -t`
